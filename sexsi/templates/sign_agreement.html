<!-- Ubicacion SEXSI -- /home/pablollh/sexsi/templates/sign_agreement.html -->

{% extends "base.html" %}
{% block content %}
<h1>Firmar Acuerdo SEXSI</h1>
<p>Para dar validez legal a esta transacción, se registrarán detalles como el origen de la solicitud, fecha, hora y, en la medida de lo posible, la ubicación de ambas partes.</p>
<p>Por favor, sube tu firma electrónica o utiliza la opción de firma biométrica.</p>

{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <label for="signature">Firma Electrónica:</label>
    <input type="file" name="signature" id="signature" accept="image/*">
    <br>
    <img id="preview" src="#" alt="Vista previa de la firma" style="display:none; max-width: 200px; margin-top: 10px;">
    <br>
    <button type="submit">Enviar Firma</button>
</form>

<!-- Sección para firma biométrica -->
<h2>Opción de Firma Biométrica</h2>
<button id="startBiometric">Capturar Firma Biométrica</button>
<canvas id="biometricCanvas" style="display:none; border: 1px solid black;"></canvas>
<button id="sendBiometric" style="display:none;">Enviar Firma Biométrica</button>

<script>
    document.getElementById("signature").onchange = function (event) {
        var reader = new FileReader();
        reader.onload = function () {
            var img = document.getElementById("preview");
            img.src = reader.result;
            img.style.display = "block";
        };
        reader.readAsDataURL(event.target.files[0]);
    };

    // Capturar firma biométrica desde canvas
    document.getElementById("startBiometric").addEventListener("click", function() {
        let canvas = document.getElementById("biometricCanvas");
        let ctx = canvas.getContext("2d");
        canvas.width = 300;
        canvas.height = 150;
        canvas.style.display = "block";
        document.getElementById("sendBiometric").style.display = "block";
        ctx.fillStyle = "#FFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    });

    document.getElementById("sendBiometric").addEventListener("click", function() {
        let canvas = document.getElementById("biometricCanvas");
        let biometricData = canvas.toDataURL("image/png").replace("data:image/png;base64,", "");
        
        fetch("{% url 'sexsi:save_biometric_signature' agreement.id %}?token={{ token }}&signer={{ signer }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ biometric_data: biometricData })
        })
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => alert("Error enviando firma biométrica"));
    });
</script>

{% endblock %}
