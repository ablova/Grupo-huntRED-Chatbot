{% load static %}

<!-- Componente de grÃ¡fico reutilizable -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ chart.title }}</h5>
        {% if chart.refresh %}
            <button class="btn btn-sm btn-primary" onclick="refreshChart('{{ chart.id }}')">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
        {% endif %}
    </div>
    <div class="card-body">
        <canvas id="{{ chart.id }}" class="chart-container"></canvas>
    </div>
    {% if chart.description %}
    <div class="card-footer">
        <small class="text-muted">{{ chart.description }}</small>
    </div>
    {% endif %}
</div>

<script>
    function createChart(id, config) {
        const ctx = document.getElementById(id).getContext('2d');
        return new Chart(ctx, {
            type: config.type || 'bar',
            data: {
                labels: config.labels,
                datasets: config.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false,
                    },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }

    function refreshChart(id) {
        const chart = Chart.getChart(id);
        if (chart) {
            fetch(`/api/charts/${id}/data/`)
                .then(response => response.json())
                .then(data => {
                    chart.data.labels = data.labels;
                    chart.data.datasets = data.datasets;
                    chart.update();
                });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        createChart('{{ chart.id }}', {
            type: '{{ chart.type }}',
            labels: {{ chart.labels|safe }},
            datasets: {{ chart.datasets|safe }}
        });
    });
</script>
