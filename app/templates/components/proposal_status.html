{% load static %}

<!-- Componente de estado de propuesta y contrato -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Estado de la Propuesta y Contrato</h5>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" 
                    onclick="downloadProposal('{{ proposal.id }}')">
                <i class="fas fa-file-pdf"></i> Descargar Propuesta
            </button>
            {% if proposal.status == 'SENT' %}
                <button class="btn btn-sm btn-outline-success" 
                        onclick="sendReminder('{{ proposal.id }}')">
                    <i class="fas fa-bell"></i> Recordatorio
                </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <!-- Timeline de estados -->
        <div class="timeline">
            <!-- Estado de Propuesta -->
            <div class="timeline-item">
                <div class="timeline-icon">
                    <i class="fas fa-file-contract"></i>
                </div>
                <div class="timeline-content">
                    <h6 class="mb-1">Propuesta</h6>
                    <p class="text-muted mb-2">{{ proposal.status }}</p>
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar bg-{{ proposal.status_color }}" 
                             role="progressbar" 
                             style="width: {{ proposal.progress }}%"></div>
                    </div>
                    <small class="text-muted">{{ proposal.created_at|date:"d/m/Y H:i" }}</small>
                </div>
            </div>

            <!-- Estado de Contrato -->
            {% if proposal.contrato %}
                <div class="timeline-item">
                    <div class="timeline-icon">
                        <i class="fas fa-file-signature"></i>
                    </div>
                    <div class="timeline-content">
                        <h6 class="mb-1">Contrato</h6>
                        <p class="text-muted mb-2">{{ proposal.contrato.status }}</p>
                        <div class="progress mb-2" style="height: 6px;">
                            <div class="progress-bar bg-{{ proposal.contrato.status_color }}" 
                                 role="progressbar" 
                                 style="width: {{ proposal.contrato.progress }}%"></div>
                        </div>
                        <small class="text-muted">{{ proposal.contrato.created_at|date:"d/m/Y H:i" }}</small>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Métricas financieras -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total</h5>
                        <h2 class="card-text mb-0">${{ proposal.pricing_total|floatformat:"2" }}</h2>
                        <p class="card-text">
                            <small>{{ proposal.pricing_details|length }} vacantes</small>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Por Cobrar</h5>
                        <h2 class="card-text mb-0">${{ proposal.pending_amount|floatformat:"2" }}</h2>
                        <p class="card-text">
                            <small>{{ proposal.pending_milestones|length }} hitos</small>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Pagado</h5>
                        <h2 class="card-text mb-0">${{ proposal.paid_amount|floatformat:"2" }}</h2>
                        <p class="card-text">
                            <small>{{ proposal.paid_milestones|length }} hitos</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de hitos de pago -->
        <div class="mt-4">
            <h6 class="mb-3">Hitos de Pago</h6>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hito</th>
                            <th>Evento</th>
                            <th>Porcentaje</th>
                            <th>Estado</th>
                            <th>Fecha Vencimiento</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for milestone in proposal.payment_milestones %}
                            <tr>
                                <td>{{ milestone.name }}</td>
                                <td>{{ milestone.get_trigger_event_display }}</td>
                                <td>{{ milestone.percentage }}%</td>
                                <td>
                                    <span class="badge bg-{{ milestone.status_color }}">
                                        {{ milestone.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if milestone.due_date %}
                                        {{ milestone.due_date|date:"d/m/Y" }}
                                    {% else %}
                                        Pendiente
                                    {% endif %}
                                </td>
                                <td>
                                    {% if milestone.status == 'PENDING' %}
                                        <button class="btn btn-sm btn-primary" 
                                                onclick="markAsPaid('{{ milestone.id }}')">
                                            Marcar como Pagado
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function downloadProposal(proposalId) {
    window.location.href = `/proposals/${proposalId}/download/`;
}

function sendReminder(proposalId) {
    const url = `/proposals/${proposalId}/send_reminder/`;
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success('Recordatorio enviado exitosamente');
        } else {
            toastr.error(data.error || 'Error al enviar recordatorio');
        }
    });
}

function markAsPaid(milestoneId) {
    if (!confirm('¿Está seguro de marcar este hito como pagado?')) {
        return;
    }
    
    const url = `/payment_milestones/${milestoneId}/mark_as_paid/`;
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            toastr.error(data.error || 'Error al marcar como pagado');
        }
    });
}
</script>
