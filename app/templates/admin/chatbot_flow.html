<!-- /home/amigro/app/templates/admin/chatbot_flow.html -->
 {% extends "admin/base_site.html" %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/gojs/2.1.53/go.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<style>
    #myDiagramDiv { width: 100%; height: 600px; background-color: #DAE4E4; border: 1px solid #ccc; }
    .controls { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
    .controls button { padding: 10px; border: none; background-color: #007bff; color: white; cursor: pointer; border-radius: 4px; }
    .controls button:hover { background-color: #0056b3; }
    #nodeProperties { width: 300px; padding: 10px; border: 1px solid #ccc; margin-top: 20px; }
</style>
{% endblock %}

{% block content %}
<h1>Editor de Flujo del Chatbot</h1>

<div id="flowSelectorContainer">
    <label for="flowSelector"><strong>Seleccionar Flujo:</strong></label>
    <select id="flowSelector" onchange="loadSelectedFlow()">
        {% for fl in flows %}
            <option value="{{ fl.id }}" {% if fl.id == flow.id %}selected{% endif %}>{{ fl.name }}</option>
        {% endfor %}
    </select>
</div>

<div id="myDiagramDiv"></div>

<div class="controls">
    <button onclick="addNode('text')"><i class="fas fa-comment-alt"></i> A침adir Pregunta/Texto</button>
    <button onclick="saveFlow()"><i class="fas fa-save"></i> Guardar Flujo</button>
    <button onclick="exportFlow()"><i class="fas fa-file-export"></i> Exportar Flujo</button>
</div>

<div id="nodeProperties">
    <h3>Propiedades del Nodo</h3>
    <label for="nodeText">Texto del nodo:</label>
    <input type="text" id="nodeText" placeholder="Texto del nodo">
    <button onclick="updateSelectedNode()"><i class="fas fa-edit"></i> Actualizar Nodo</button>
</div>

<script>
    let myDiagram;
    const flowmodel_id = "{{ flow.id }}";

    function init() {
        const $ = go.GraphObject.make;
        myDiagram = $(go.Diagram, "myDiagramDiv", {
            "undoManager.isEnabled": true,
            initialContentAlignment: go.Spot.Center,
            model: $(go.GraphLinksModel, { linkKeyProperty: "key", nodeKeyProperty: "key" })
        });

        // Definici칩n del template de nodo
        myDiagram.nodeTemplate = $(go.Node, "Auto",
            $(go.Shape, "RoundedRectangle", { fill: "lightblue" }),
            $(go.TextBlock, { margin: 8, editable: true },
                new go.Binding("text").makeTwoWay()
            )
        );

        // Evento para actualizar el campo de texto del nodo seleccionado
        myDiagram.addDiagramListener("ObjectSingleClicked", function(e) {
            const selectedNode = e.subject.part;
            if (selectedNode) {
                document.getElementById("nodeText").value = selectedNode.data.text || "";
            }
        });

        loadSelectedFlow();
    }

    // Cargar el flujo seleccionado
    function loadSelectedFlow() {
        const selectedFlowId = document.getElementById("flowSelector").value;
        const urlLoadFlowData = "{% url 'load_flow_data' 0 %}".replace('0', selectedFlowId);
        fetch(urlLoadFlowData, {
            method: 'GET',
            headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Accept': 'application/json' },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            const modelData = {
                nodeDataArray: data.flow_data.nodes,
                linkDataArray: data.flow_data.links
            };
            myDiagram.model = new go.GraphLinksModel(modelData.nodeDataArray, modelData.linkDataArray);
        })
        .catch(error => console.error('Error al cargar el flujo:', error));
    }

    // Guardar el flujo actual
    function saveFlow() {
        const flowData = {
            flowmodel_id,
            nodes: myDiagram.model.nodeDataArray,
            links: myDiagram.model.linkDataArray
        };
        fetch("{% url 'save_flow_structure' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(flowData)
        })
        .then(response => response.json())
        .then(data => alert(data.status === 'success' ? 'Flujo guardado exitosamente' : 'Error al guardar el flujo'))
        .catch(error => console.error('Error al guardar el flujo:', error));
    }

    // A침adir un nuevo nodo
    function addNode(type) {
        const newNodeData = { key: myDiagram.model.nodeDataArray.length + 1, text: "Nuevo nodo" };
        myDiagram.model.addNodeData(newNodeData);
    }

    // Eliminar el nodo seleccionado
    function deleteSelectedNode() {
        const selectedNode = myDiagram.selection.first();
        if (selectedNode) {
            myDiagram.model.removeNodeData(selectedNode.data);
        } else {
            alert("Selecciona un nodo para eliminar.");
        }
    }

    // Actualizar el nodo seleccionado con el texto ingresado
    function updateSelectedNode() {
        const selectedNode = myDiagram.selection.first();
        const newText = document.getElementById("nodeText").value;
        if (selectedNode) {
            myDiagram.model.setDataProperty(selectedNode.data, "text", newText);
        } else {
            alert("Selecciona un nodo para actualizar.");
        }
    }

    // Exportar el flujo actual en formato JSON
    function exportFlow() {
        const flowData = {
            nodes: myDiagram.model.nodeDataArray,
            links: myDiagram.model.linkDataArray
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(flowData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "flow_data.json");
        document.body.appendChild(downloadAnchorNode); // required for firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // Funci칩n para obtener la cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener("DOMContentLoaded", init);
</script>
{% endblock %}