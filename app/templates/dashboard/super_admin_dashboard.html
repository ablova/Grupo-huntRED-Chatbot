{% extends 'base.html' %}
{% load static %}

{% block title %}ðŸš€ Super Admin Dashboard - BRUCE ALMIGHTY MODE ðŸš€{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/aura.css' %}">
<link rel="stylesheet" href="{% static 'css/super_admin.css' %}">
<link rel="stylesheet" href="{% static 'css/admin-enhancements.css' %}">

{% endblock %}

{% block content %}
<!-- BRUCE ALMIGHTY MODE INDICATOR ðŸš€ -->
<div class="god-mode-indicator">
    ðŸš€ BRUCE ALMIGHTY MODE ACTIVATED ðŸš€
</div>

<!-- HEADER ESPECTACULAR -->
<div class="bruce-almighty-header">
    <h1 class="bruce-almighty-title">ðŸ§  SUPER ADMIN DASHBOARD</h1>
    <p class="bruce-almighty-subtitle">Control Total del Sistema huntRED - Â¡Eres el DIOS de la plataforma! ðŸš€</p>
</div>

<!-- PANEL DE CONTROL TOTAL -->
<div class="control-panel">
    <h3><i class="fas fa-crown"></i> Panel de Control Total</h3>
    <div class="row">
        <div class="col-md-3">
            <button class="control-button" onclick="controlAura('restart')">
                <i class="fas fa-sync"></i> Reiniciar AURA
            </button>
        </div>
        <div class="col-md-3">
            <button class="control-button" onclick="controlGenia('restart')">
                <i class="fas fa-brain"></i> Reiniciar GenIA
            </button>
        </div>
        <div class="col-md-3">
            <button class="control-button" onclick="forceAnalysis()">
                <i class="fas fa-chart-line"></i> Forzar AnÃ¡lisis
            </button>
        </div>
        <div class="col-md-3">
            <button class="emergency-button" onclick="emergencyAction('system_backup')">
                <i class="fas fa-shield-alt"></i> Backup Sistema
            </button>
        </div>
    </div>
</div>

<!-- MÃ‰TRICAS GLOBALES -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-value" id="total-users">--</div>
        <div class="metric-label">Total Usuarios</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="active-consultants">--</div>
        <div class="metric-label">Consultores Activos</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="active-clients">--</div>
        <div class="metric-label">Clientes Activos</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="total-candidates">--</div>
        <div class="metric-label">Total Candidatos</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="conversion-rate">--</div>
        <div class="metric-label">Tasa de ConversiÃ³n</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="revenue-generated">--</div>
        <div class="metric-label">Ingresos Generados</div>
    </div>
</div>

<!-- SALUD DEL SISTEMA -->
<div class="system-health">
    <h3><i class="fas fa-heartbeat"></i> Salud del Sistema</h3>
    <div class="row">
        <div class="col-md-2">
            <div class="health-indicator health-excellent"></div>
            <strong>General: 95.5%</strong>
        </div>
        <div class="col-md-2">
            <div class="health-indicator health-excellent"></div>
            <strong>AURA: 98.2%</strong>
        </div>
        <div class="col-md-2">
            <div class="health-indicator health-good"></div>
            <strong>GenIA: 94.8%</strong>
        </div>
        <div class="col-md-2">
            <div class="health-indicator health-excellent"></div>
            <strong>ML: 96.3%</strong>
        </div>
        <div class="col-md-2">
            <div class="health-indicator health-excellent"></div>
            <strong>DB: 99.1%</strong>
        </div>
        <div class="col-md-2">
            <div class="health-indicator health-excellent"></div>
            <strong>API: 97.7%</strong>
        </div>
    </div>
</div>

<!-- ESTADO DE IA -->
<div class="ai-status-grid">
    <div class="ai-status-card">
        <div class="ai-name">ðŸ§  AURA</div>
        <div class="ai-status">Operacional</div>
        <div class="ai-metrics">
            <div class="ai-metric">
                <div class="ai-metric-value">99.9%</div>
                <div class="ai-metric-label">Uptime</div>
            </div>
            <div class="ai-metric">
                <div class="ai-metric-value">150ms</div>
                <div class="ai-metric-label">Response</div>
            </div>
        </div>
    </div>
    
    <div class="ai-status-card">
        <div class="ai-name">ðŸ¤– GenIA</div>
        <div class="ai-status">Operacional</div>
        <div class="ai-metrics">
            <div class="ai-metric">
                <div class="ai-metric-value">99.7%</div>
                <div class="ai-metric-label">Uptime</div>
            </div>
            <div class="ai-metric">
                <div class="ai-metric-value">200ms</div>
                <div class="ai-metric-label">Response</div>
            </div>
        </div>
    </div>
    
    <div class="ai-status-card">
        <div class="ai-name">ðŸ“Š ML</div>
        <div class="ai-status">Operacional</div>
        <div class="ai-metrics">
            <div class="ai-metric">
                <div class="ai-metric-value">99.5%</div>
                <div class="ai-metric-label">Uptime</div>
            </div>
            <div class="ai-metric">
                <div class="ai-metric-value">100ms</div>
                <div class="ai-metric-label">Response</div>
            </div>
        </div>
    </div>
</div>

<!-- MONITOR EN TIEMPO REAL -->
<div class="real-time-monitor">
    <h3><i class="fas fa-tachometer-alt"></i> Monitor en Tiempo Real</h3>
    <div class="monitor-grid">
        <div class="monitor-item">
            <div class="monitor-value" id="active-users">--</div>
            <div class="monitor-label">Usuarios Activos</div>
        </div>
        <div class="monitor-item">
            <div class="monitor-value" id="active-sessions">--</div>
            <div class="monitor-label">Sesiones Activas</div>
        </div>
        <div class="monitor-item">
            <div class="monitor-value" id="requests-per-minute">--</div>
            <div class="monitor-label">Requests/min</div>
        </div>
        <div class="monitor-item">
            <div class="monitor-value" id="avg-response-time">--</div>
            <div class="monitor-label">Response Time</div>
        </div>
        <div class="monitor-item">
            <div class="monitor-value" id="error-rate">--</div>
            <div class="monitor-label">Error Rate</div>
        </div>
    </div>
</div>

<!-- PANEL DE MENSAJES DIRECTOS -->
<div class="direct-message-panel">
    <h3><i class="fas fa-comments"></i> Mensajes Directos (Control Total)</h3>
    <form class="message-form" id="direct-message-form">
        <div class="row">
            <div class="col-md-3">
                <select class="message-input" id="user-select" required>
                    <option value="">Seleccionar Usuario</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="message-input" id="channel-select" required>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="email">Email</option>
                    <option value="sms">SMS</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" class="message-input" id="message-input" placeholder="Tu mensaje divino..." required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="send-button">
                    <i class="fas fa-paper-plane"></i> Enviar
                </button>
            </div>
        </div>
    </form>
</div>

<!-- TABS PARA DIFERENTES SECCIONES -->
<ul class="nav nav-tabs" id="superAdminTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="consultants-tab" data-toggle="tab" href="#consultants" role="tab">
            <i class="fas fa-users"></i> Consultores
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="clients-tab" data-toggle="tab" href="#clients" role="tab">
            <i class="fas fa-building"></i> Clientes
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="candidates-tab" data-toggle="tab" href="#candidates" role="tab">
            <i class="fas fa-user-graduate"></i> Candidatos
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="processes-tab" data-toggle="tab" href="#processes" role="tab">
            <i class="fas fa-cogs"></i> Procesos
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="aura-tab" data-toggle="tab" href="#aura" role="tab">
            <i class="fas fa-brain"></i> AURA
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="genia-tab" data-toggle="tab" href="#genia" role="tab">
            <i class="fas fa-robot"></i> GenIA
        </a>
    </li>
</ul>

<div class="tab-content" id="superAdminTabContent">
    <div class="tab-pane fade show active" id="consultants" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Analytics de Consultores</h5>
                <div id="consultants-content">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="clients" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Analytics de Clientes</h5>
                <div id="clients-content">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="candidates" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Analytics de Candidatos</h5>
                <div id="candidates-content">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="processes" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Analytics de Procesos</h5>
                <div id="processes-content">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="aura" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Analytics de AURA</h5>
                <div id="aura-content">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="genia" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Analytics de GenIA</h5>
                <div id="genia-content">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Cargar datos iniciales
    loadSystemOverview();
    loadUsersForMessage();
    
    // Actualizar datos cada 30 segundos
    setInterval(loadSystemOverview, 30000);
    
    // Manejar envÃ­o de mensajes directos
    $('#direct-message-form').on('submit', function(e) {
        e.preventDefault();
        sendDirectMessage();
    });
    
    // Cargar datos de tabs
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr("href");
        switch(target) {
            case '#consultants':
                loadConsultantAnalytics();
                break;
            case '#clients':
                loadClientAnalytics();
                break;
            case '#candidates':
                loadCandidateAnalytics();
                break;
            case '#processes':
                loadProcessAnalytics();
                break;
            case '#aura':
                loadAuraAnalytics();
                break;
            case '#genia':
                loadGeniaAnalytics();
                break;
        }
    });
});

function showLoading() {
    $('#loading-overlay').show();
}

function hideLoading() {
    $('#loading-overlay').hide();
}

function loadSystemOverview() {
    $.get('/super-admin/system-overview/')
        .done(function(data) {
            if (data.success) {
                displaySystemOverview(data.overview);
            }
        })
        .fail(function() {
            console.error('Error cargando overview del sistema');
        });
}

function displaySystemOverview(overview) {
    const metrics = overview.global_metrics;
    const realTime = overview.real_time_performance;
    
    $('#total-users').text(metrics.total_users);
    $('#active-consultants').text(metrics.active_consultants);
    $('#active-clients').text(metrics.active_clients);
    $('#total-candidates').text(metrics.total_candidates);
    $('#conversion-rate').text(metrics.conversion_rate.toFixed(1) + '%');
    $('#revenue-generated').text('$' + metrics.revenue_generated.toLocaleString());
    
    $('#active-users').text(realTime.active_users);
    $('#active-sessions').text(realTime.active_sessions);
    $('#requests-per-minute').text(realTime.requests_per_minute);
    $('#avg-response-time').text(realTime.average_response_time);
    $('#error-rate').text(realTime.error_rate);
}

function loadUsersForMessage() {
    $.get('/super-admin/user-management/')
        .done(function(data) {
            if (data.success) {
                const select = $('#user-select');
                data.users.forEach(user => {
                    select.append(`<option value="${user.id}">${user.name} (${user.role})</option>`);
                });
            }
        });
}

function sendDirectMessage() {
    const userId = $('#user-select').val();
    const message = $('#message-input').val();
    const channel = $('#channel-select').val();
    
    if (!userId || !message) {
        alert('Por favor completa todos los campos');
        return;
    }
    
    showLoading();
    
    $.ajax({
        url: '/super-admin/direct-message/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            user_id: userId,
            message: message,
            channel: channel
        }),
        success: function(data) {
            hideLoading();
            if (data.success) {
                alert('Â¡Mensaje enviado con Ã©xito!');
                $('#message-input').val('');
            } else {
                alert('Error: ' + data.error);
            }
        },
        error: function() {
            hideLoading();
            alert('Error enviando mensaje');
        }
    });
}

function controlAura(action) {
    if (!confirm('Â¿EstÃ¡s seguro de que quieres ' + action + ' AURA?')) return;
    
    showLoading();
    
    $.ajax({
        url: '/super-admin/aura-control/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: action,
            parameters: {}
        }),
        success: function(data) {
            hideLoading();
            if (data.success) {
                alert('Â¡AURA controlado con Ã©xito!');
                loadSystemOverview();
            } else {
                alert('Error: ' + data.error);
            }
        },
        error: function() {
            hideLoading();
            alert('Error controlando AURA');
        }
    });
}

function controlGenia(action) {
    if (!confirm('Â¿EstÃ¡s seguro de que quieres ' + action + ' GenIA?')) return;
    
    showLoading();
    
    $.ajax({
        url: '/super-admin/genia-control/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: action,
            parameters: {}
        }),
        success: function(data) {
            hideLoading();
            if (data.success) {
                alert('Â¡GenIA controlado con Ã©xito!');
                loadSystemOverview();
            } else {
                alert('Error: ' + data.error);
            }
        },
        error: function() {
            hideLoading();
            alert('Error controlando GenIA');
        }
    });
}

function forceAnalysis() {
    if (!confirm('Â¿Forzar anÃ¡lisis global del sistema?')) return;
    
    showLoading();
    
    $.ajax({
        url: '/super-admin/aura-control/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: 'force_analysis',
            parameters: {}
        }),
        success: function(data) {
            hideLoading();
            if (data.success) {
                alert('Â¡AnÃ¡lisis forzado con Ã©xito!');
                loadSystemOverview();
            } else {
                alert('Error: ' + data.error);
            }
        },
        error: function() {
            hideLoading();
            alert('Error forzando anÃ¡lisis');
        }
    });
}

function emergencyAction(action) {
    if (!confirm('Â¿ACCIONES DE EMERGENCIA - Â¿EstÃ¡s completamente seguro?')) return;
    
    showLoading();
    
    $.ajax({
        url: '/super-admin/emergency-actions/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            action: action,
            parameters: {}
        }),
        success: function(data) {
            hideLoading();
            if (data.success) {
                alert('Â¡AcciÃ³n de emergencia ejecutada!');
                loadSystemOverview();
            } else {
                alert('Error: ' + data.error);
            }
        },
        error: function() {
            hideLoading();
            alert('Error en acciÃ³n de emergencia');
        }
    });
}

function loadConsultantAnalytics() {
    $.get('/super-admin/consultant-analytics/')
        .done(function(data) {
            if (data.success) {
                $('#consultants-content').html(formatConsultantAnalytics(data.analytics));
            }
        });
}

function loadClientAnalytics() {
    $.get('/super-admin/client-analytics/')
        .done(function(data) {
            if (data.success) {
                $('#clients-content').html(formatClientAnalytics(data.analytics));
            }
        });
}

function loadCandidateAnalytics() {
    $.get('/super-admin/candidate-analytics/')
        .done(function(data) {
            if (data.success) {
                $('#candidates-content').html(formatCandidateAnalytics(data.analytics));
            }
        });
}

function loadProcessAnalytics() {
    $.get('/super-admin/process-analytics/')
        .done(function(data) {
            if (data.success) {
                $('#processes-content').html(formatProcessAnalytics(data.analytics));
            }
        });
}

function loadAuraAnalytics() {
    $.get('/super-admin/aura-analytics/')
        .done(function(data) {
            if (data.success) {
                $('#aura-content').html(formatAuraAnalytics(data.analytics));
            }
        });
}

function loadGeniaAnalytics() {
    $.get('/super-admin/genia-analytics/')
        .done(function(data) {
            if (data.success) {
                $('#genia-content').html(formatGeniaAnalytics(data.analytics));
            }
        });
}

// Funciones de formato (implementar segÃºn necesidades)
function formatConsultantAnalytics(analytics) {
    return '<p>Analytics de consultores cargados</p>';
}

function formatClientAnalytics(analytics) {
    return '<p>Analytics de clientes cargados</p>';
}

function formatCandidateAnalytics(analytics) {
    return '<p>Analytics de candidatos cargados</p>';
}

function formatProcessAnalytics(analytics) {
    return '<p>Analytics de procesos cargados</p>';
}

function formatAuraAnalytics(analytics) {
    return '<p>Analytics de AURA cargados</p>';
}

function formatGeniaAnalytics(analytics) {
    return '<p>Analytics de GenIA cargados</p>';
}
</script>
{% endblock %} 