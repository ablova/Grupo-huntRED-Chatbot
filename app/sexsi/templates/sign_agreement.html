<!-- Ubicacion SEXSI -- /home/pablollh/app/sexsi/templates/sign_agreement.html -->

{% extends "base.html" %}
{% block content %}
<h1 align="center">Firmar Acuerdo SEXSI</h1>
<p>Para brindar la mayor validez legal a esta transacci√≥n, se registrar√°n detalles como el origen de la solicitud, fecha, hora y ubicaci√≥n de ambas partes.</p>

{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<p>Firmando como: 
    <strong>
        {% if signer == "creator" %}
            Creador - {{ agreement.creator.username }}
        {% else %}
            Invitado - {{ agreement.invitee_contact }}
        {% endif %}
    </strong>
</p>

<h2>Opciones de Firma</h2>

<h3>üì∏ Firma con Identificaci√≥n (Selfie + INE/Pasaporte)</h3>
<p><strong>Importante:</strong> Sube una imagen donde aparezca tu identificaci√≥n oficial (INE o pasaporte) junto con tu rostro.</p>
<p>‚ö†Ô∏è <strong>Si la imagen no cumple con estos requisitos, el acuerdo podr√≠a ser inv√°lido.</strong></p>

<form id="signatureForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <label for="signature">Realizar Selfie con Identificaci√≥n Oficial:</label>
    <input type="file" name="signature" id="signature" accept="image/*" capture="user">
    <br>
    <img id="preview" src="#" alt="Vista previa de la imagen" style="display:none; max-width: 250px; margin-top: 10px;">
    <br>
    <h3>‚úçÔ∏è Firma Aut√≥grafa (Dibujar en pantalla)</h3>
    <p>Usa tu dedo o un stylus para firmar en el recuadro.</p>
    <div id="signature-container">
        <canvas id="biometricCanvas"></canvas>
    </div>
    <button type="button" id="clearBiometric">üóë Limpiar Firma</button>
    <br><br>
    <button type="button" id="sendBiometric">Enviar Firma y Selfie</button>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let canvas = document.getElementById("biometricCanvas");
        let ctx = canvas.getContext("2d");
        let isDrawing = false;
        let userLat = null;
        let userLon = null;
        let signer = "{{ signer }}";
        let token = "{{ token }}";
        let agreementId = "{{ agreement.id }}";

        function resizeCanvas() {
            canvas.width = Math.min(window.innerWidth * 0.9, 350);
            canvas.height = 200;
            ctx.fillStyle = "#FFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    userLat = position.coords.latitude;
                    userLon = position.coords.longitude;
                }, error => {
                    console.warn("‚ö†Ô∏è No se pudo obtener la ubicaci√≥n:", error);
                });
            }
        }
        getLocation();

        function startDrawing(event) {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(event.offsetX || event.touches[0].clientX, event.offsetY || event.touches[0].clientY);
            event.preventDefault();
        }

        function draw(event) {
            if (!isDrawing) return;
            ctx.lineTo(event.offsetX || event.touches[0].clientX, event.offsetY || event.touches[0].clientY);
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.stroke();
            event.preventDefault();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseleave", stopDrawing);
        canvas.addEventListener("touchstart", startDrawing);
        canvas.addEventListener("touchmove", draw);
        canvas.addEventListener("touchend", stopDrawing);

        document.getElementById("clearBiometric").addEventListener("click", function () {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#FFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        document.getElementById("sendBiometric").addEventListener("click", function () {
            let biometricData = canvas.toDataURL("image/png");
            let selfieFile = document.getElementById("signature").files[0];
            let formData = new FormData();

            if (!selfieFile && biometricData.length < 1000) {
                alert("‚ö†Ô∏è Debes subir una selfie con identificaci√≥n y/o firmar en el recuadro.");
                return;
            }

            if (selfieFile) {
                formData.append("signature", selfieFile);
            }
            if (biometricData.length >= 1000) {
                formData.append("biometric_data", biometricData);
            }
            formData.append("latitude", userLat || "Ubicaci√≥n desconocida");
            formData.append("longitude", userLon || "Ubicaci√≥n desconocida");

            fetch(`/app/sexsi/sign/save/${agreementId}/${signer}/${token}/`, {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("‚úÖ Firma enviada con √©xito.");
                    window.location.href = `/app/sexsi/agreement/${agreementId}/`;
                } else {
                    alert("‚ö†Ô∏è Error: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error en el env√≠o:", error);
                alert("‚ö†Ô∏è Hubo un problema al enviar los datos.");
            });
        });
    });
</script>

<style>
    #signature-container {
        touch-action: none;
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
    }

    canvas {
        border: 2px solid black;
        background-color: white;
    }
</style>
{% endblock %}